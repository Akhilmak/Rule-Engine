<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rule Creator and Evaluator</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin: auto;
        padding: 100px;
        border-radius: 5px;
        width: 400px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
      }
      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
      }
      button {
        padding: 10px 15px;
        background-color: #28a745;
        color: white;
        margin: auto;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #218838;
      }
      .btn {
        padding: 10px 15px;
        background-color: #28a745;
        display: flex;
        color: white;
        margin: auto;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div>
      <h2>Create Rule</h2>
      <div class="form-group">
        <label for="ruleName">Rule Name:</label>
        <input
          required
          type="text"
          id="ruleName"
          placeholder="Enter rule name"
        />
      </div>
      <div class="form-group">
        <label for="ruleInput"
          >Enter Rule (e.g., (age > 30 AND department = 'Sales')):</label
        >
        <input
          type="text"
          id="ruleInput"
          placeholder="Enter your rule here"
          required
        />
      </div>
      <button onclick="createRule()" class="btn">Create</button>
    </div>

    <div>
      <h2>Evaluate Data</h2>
      <div class="form-group">
        <label for="ruleSelect">Select Rule:</label>
        <select id="ruleSelect"></select>
      </div>
      <div class="form-group">
        <label for="age">Age:</label>
        <input type="number" id="age" placeholder="Enter age" />
      </div>
      <div class="form-group">
        <label for="salary">Salary:</label>
        <input type="number" id="salary" placeholder="Enter salary" />
      </div>
      <div class="form-group">
        <label for="department">Department:</label>
        <input type="text" id="department" placeholder="Enter department" />
      </div>
      <div class="form-group">
        <label for="experience">Experience:</label>
        <input
          type="number"
          id="experience"
          placeholder="Enter experience in years"
        />
      </div>
      <button class="btn" onclick="submitRule()">Submit</button>
    </div>

    <h2>Result</h2>
    <p id="result"></p>

    <script>
      // Fetch rules from the server and populate the dropdown
      function fetchRules() {
        fetch("http://localhost:8080/api/rules")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((rules) => {
            const ruleSelect = document.getElementById("ruleSelect");
            ruleSelect.innerHTML = ""; // Clear existing options
            rules.forEach((rule) => {
              const option = document.createElement("option");
              option.value = rule.id; // Assuming each rule has an 'id' property
              option.textContent = `${rule.id}: ${rule.ruleName}`; // Show both ID and name
              ruleSelect.appendChild(option);
            });
          })
          .catch((error) => console.error("Error fetching rules:", error));
      }

      // Call fetchRules when the page loads
      window.onload = fetchRules;

      function createRule() {
        const ruleName = document.getElementById("ruleName").value.trim();
        const ruleInput = document.getElementById("ruleInput").value.trim();

        console.log("Rule Name:", ruleName); // Debugging line
        console.log("Rule Input:", ruleInput);
        // Basic validation
        if (!ruleName || !ruleInput) {
          document.getElementById("result").innerText =
            "Please enter both a rule name and a rule.";
          return;
        }

        const data = {
          ruleName: ruleName,
          ruleString: ruleInput,
        };

        fetch("http://localhost:8080/api/rules/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((result) => {
            document.getElementById(
              "result"
            ).innerText = `Rule Created Successfully! Name: ${result.ruleName}`;
            fetchRules(); // Refresh the rules dropdown after creating a new rule
          })
          .catch((error) => {
            document.getElementById(
              "result"
            ).innerText = `Error creating rule: ${error.message}`;
          });
      }

      function submitRule() {
        const selectedRuleId = parseInt(
          document.getElementById("ruleSelect").value
        ); // Get selected rule ID
        console.log("Selected Rule ID:", selectedRuleId);
        const age = parseInt(document.getElementById("age").value);
        const salary = parseInt(document.getElementById("salary").value);
        const department = document.getElementById("department").value.trim();
        const experience = parseInt(
          document.getElementById("experience").value
        );

        // Basic validation
        if (
          !selectedRuleId ||
          isNaN(age) ||
          isNaN(salary) ||
          !department ||
          isNaN(experience)
        ) {
          document.getElementById("result").innerText =
            "Please fill out all fields.";
          return;
        }

        // Prepare data in the expected format
        const data = {
          ruleId: selectedRuleId, // Include selected rule ID in the request
          data: {
            age,
            salary,
            department,
            experience,
          },
        };

        console.log("Data:", data);

        fetch("http://localhost:8080/api/rules/evaluate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data), // Send the data as a JSON string
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((result) => {
            document.getElementById(
              "result"
            ).innerText = `Evaluation Result: ${result}`;
          })
          .catch((error) => {
            document.getElementById(
              "result"
            ).innerText = `Error evaluating rule: ${error.message}`;
          });
      }
    </script>
  </body>
</html>
